---
import type { AnyFeaturableDocument, Language } from '@root/sanity/sanity.types';
import { DEFAULT_LANGUAGE_ID, SUPPORTED_LANGUAGES_IDS, SUPPORTED_LANGUAGES_RECORD, UI_DICTIONARY } from '@lib/languageUtils';
import { getPreferredSlug } from '@lib/contentUtils';
import { generateRoute } from '@lib/routingUtils';
import { getFromRegistry } from '@lib/registry';
import { createSanityImage } from '@lib/imageUtils';

type Props = {
    lang: Language;
    items: AnyFeaturableDocument[];
};

const {
    lang = DEFAULT_LANGUAGE_ID,
    items,
} = Astro.props;
---

{Array.isArray(items) && items.length > 0 && (
    <aside class='featured-bar' aria-label={UI_DICTIONARY.featuredItemsLabel[lang]} style={{ '--how-many-featured-items': 1, }}>
        <ul class='featured-items'>
            {items.map((item, index) => {
                if (index === 1 )return
                const slugData = getPreferredSlug(item, lang);
                if (!slugData) return;
                const routeToItem = generateRoute(item, slugData.langUsed);
                if (!routeToItem) return;
                const itemAsRegistered = getFromRegistry(item._id);
                if (!itemAsRegistered?.[slugData.langUsed]) return;
                const thumbnail = createSanityImage({
                    source: item.mainImage,
                    width: 1200,
                    height: 800,
                });
                return (
                    <li class='featured-item'>
                        {thumbnail && (
                            <div class='thumbnail'>
                                <Fragment set:html={thumbnail} />
                            </div>
                        )}
                        <div>
                            <a href={routeToItem}>
                                {SUPPORTED_LANGUAGES_IDS.map((langId) => itemAsRegistered[langId]?.title && (
                                    <span lang={langId} dir={SUPPORTED_LANGUAGES_RECORD[langId].dir}>
                                        <bdi>{itemAsRegistered[langId]?.title}</bdi>
                                    </span>
                                ))}
                            </a>
                        </div>
                    </li>
                );
            })}
        </ul>
    </aside>
)}

<style lang='scss'>
    ul, li {
        list-style: none;
    }
    .featured-items {
        display: flex;
        gap: var(--featured-items-gap);
    }
    .featured-item {
        position: relative;
        display: flex;
        flex-direction: column;
        row-gap: 0.5rem;
        flex: 1 1 calc((100% - ((var(--how-many-featured-items) - 1) * var(--featured-items-gap))) / var(--how-many-featured-items));
        min-width: 0;
        max-width: var(--featured-item-max-width);
        padding-top: var(--featured-item-padding-top);
        padding-bottom: var(--featured-item-padding-bottom);
        padding-inline: var(--featured-item-padding-inline);
        outline: 1px solid;
    }
    a {
        display: flex;
        flex-direction: column;
        text-align: right;
        @media (any-hover: hover) {
            &:hover {
                color: var(--text-link-hover-colour);
            }
        }
    }
    a::before {
        content: '';
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    span {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        line-height: 1.5;
    }
    .thumbnail :global(img) {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }
</style>